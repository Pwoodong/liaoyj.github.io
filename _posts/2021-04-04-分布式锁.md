## 分布式锁

分布式锁是控制分布式系统之间同步访问共享资源的一种方式；在分布式系统中，常常需要协调他们的动作，如果不同的系统或是同一个系统的不同主机之间共享了一个或一组资源，那么访问这些资源的时候，往往需要互斥来防止彼此干扰来保证一致性，这就需要分布式锁。

#### 场景

效率：使用分布式锁可以避免不同节点重复相同的工作，这些工作会浪费资源

正确性：分布式锁可以避免破坏正确性的发生，如多个节点在同一条数据上操作，可能会导致数据出错，尤其是下订单涉及资金交易方面

### 特点

互斥性:互斥是基本的，分布式锁也需要保证在不同的节点不同线程的互斥

可重入性：同一阶段上的同一线程如果获取来锁之后也可以再次获取这个锁

锁超时：支持锁超时，防止死锁

高效、高可用：加锁和解锁要高效，也要保证高可用防止分布式锁失效

支持阻塞和非阻塞：支持阻塞和非阻塞，如ReentrantLock的lock、tryLock、tryLock+超时

支持公平锁和非公平锁：公平锁是按请求加锁的顺序获得锁，非公平锁相对来说就是无序的，会出现插队的情况

### 常见分布式锁

#### MySQL

1、创建锁表：涉及主键、锁名、key值、时间等字段；其中key要保证唯一性

2、提供锁的查询和删除接口

3、实现加锁和解锁功能

4、实现获取锁和解锁功能

5、利用AOP面向切面编程实现分布式锁客户端

#### Zookeeper

1、获取锁

2、判断是否有其他事物创建，如果是继续进行监听，如果否则创建加锁

3、判断创建是否成功，如果是获得锁，如果否则继续进行监听

4、获得锁后执行业务操作

5、业务操作完后，释放锁

6、监听到锁释放后循环上述步骤

#### Redis

1、基于SETNX + EXPIRE

2、基于SETNX + value值是（系统时间+过期时间）

3、使用Lua脚本(包含SETNX + EXPIRE两条指令)

4、SET的扩展命令（SET EX PX NX）

5、SET EX PX NX  + 校验唯一随机值,再释放锁

6、开源框架~Redisson

7、多机实现的分布式锁Redlock

#### 分布式锁实现DEMO

https://github.com/Pwoodong/distributed-demo