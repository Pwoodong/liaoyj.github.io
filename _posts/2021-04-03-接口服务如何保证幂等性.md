## 接口服务如何保证幂等性

### 原因

重复数据或数据不一致，前段请求重复，多次提交

### 幂等性

指多次操作，结果是一致的。

### 场景

1、查询：查询不会对数据产生任何变化，具备幂等性

2、新增：ID作为唯一主键，重复插入只会有一条数据成功，具备幂等性；ID不是唯一主键，数据可以重复插入，数据新增多条，不具备幂等性

3、修改：如果是直接赋值，具备幂等性；如果是计算赋值，每次操作计算结果不一致，就不具备幂等性

4、删除：多次操作，结果一致，具备幂等性

### 常见方案

#### 唯一主键

使用唯一主键，保证在数据库是唯一的就可以解决，利用的是数据库的主键唯一约束的特征，解决的是新增场景下的幂等问题；生成分布式主键的方法有雪花算法。

#### token机制

1、服务端提供了发送token的接口，根据业务在执行业务前先去获取token，然后服务器会把token保存到Redis缓存中

2、调用业务接口时，携带token，一般放在请求头部

3、服务器判断token是否存在Redis缓存中，如果存在表示第一次请求，执行完业务后，删除Redis中token；如果token不存在Redis缓存中，表示重复操作，直接返回重复标志给客户端

#### 乐观锁机制 

修改SQL在where条件后面加上限定语句比如版本号，这样就具备了幂等性

#### 分布式锁

1、基于Redis实现的分布式锁

2、基于Zookeeper实现的分布式锁

