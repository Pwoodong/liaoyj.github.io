# TCP流量控制与拥塞控制

## 流量控制

流量控制就是让发送方的发送速率不要太快，既要让接收方来得及接收，也不要使网络发生拥塞；如果发送方把数据发送得过快，接收方就可能来不及接收，这就会造成数据的丢失；利用滑动窗口机制可以很方便地在TCP连接上实现流量控制。

#### 例：

​	A向B发送数据，在连接建立时，B告诉A接收窗口rwnd为400字节。

<img src="http://pwoodong.gitee.io/blog/img/202103/flow-control-1.png" style="zoom:50%;" />

## 拥塞控制

在某段时间，若对网络中某资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏产生了拥塞；出现资源拥塞的条件就是对资源需求的总和大于可用资源；若网络中有许多资源同时产生拥塞，网络的性能就明显变坏，整个网络的吞吐量将随输入负荷的增大而下降。

#### 慢开始和拥塞避免

发送方维持一个叫做拥塞窗口cwnd的状态变量；拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化；发送方让自己的发送窗口等于拥塞窗口；如再考虑到接收方的接收能力，则发送窗口还可能小于拥塞窗口。

发送方拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去；但只要网络出现拥塞，拥塞窗口就要减小一些，以减少注入到网络中的分组数。

#### 慢开始算法原理

在主机刚刚开始发送报文段时可先设置拥塞窗口cwnd=1，即设置为一个最大报文段MSS的数值；在每收到一个对新的报文段的确认后，将拥塞窗口加1，即增加一个MSS的数值；用这样的方法逐步增大发送端的拥塞窗口cwnd，可以使分组注入到网络的速率更加合理。

#### 例：

<img src="http://pwoodong.gitee.io/blog/img/202103/congestion-control-1.png" style="zoom:50%;" />

TCP连接进行初始化时，拥塞窗口设置为1，慢开始门限的初始值设置为16个报文段即ssthresh=16;

当拥塞窗口cwnd增长到慢开始门限值ssthresh时，改为执行拥塞避免算法，拥塞窗口按线性规律增长；

当拥塞窗口的数值增长到24时，网络出现超时，表明网络已经拥塞，更新ssthresh值为12即发送窗口数值24的一半，拥塞窗口再重新设置为1，并执行慢开始算法；

当cwnd=12时改为执行拥塞避免算法，拥塞窗口按线性规律增长，每经过一个往返时延就增加一个MSS的大小。

#### 快重传和快恢复

快重传算法首先要求接收方每收到一个失序的报文段后就立即发出重复确认；这样做可以让发送方及早知道有报文段没有到达接收方；发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段；快重传并非取消重传计时器，而是在某些情况下可更早地重传丢失的报文段。

快恢复算法是当发送段收到连续三个重复的确认时，就执行"乘法减小"算法，把慢开始门限ssthresh减半，但接下去不执行慢开始算法；由于发送方现在认为网络很可能没有发生拥塞，因此现在不执行慢开始算法，即拥塞窗口cwnd现在不设置为1，而是设置为慢开始门限ssthresh减半后的数值，然后开始执行拥塞避免算法("加法增大")，使拥塞窗口缓慢地线性增大。

#### 例：

<img src="http://pwoodong.gitee.io/blog/img/202103/congestion-control-2.png" style="zoom:50%;" />

## 拥塞控制与流量控制关系

拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷。

拥塞控制是一个全局性的过程，涉及到所有的主机、所有的路由器，以及与降低网络传输想你有关的所有因素。

流量控制往往指在给定的发送端和接收端之间的点对点通信量的控制。

流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收。