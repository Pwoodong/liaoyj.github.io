# TCP三次握手四次挥手

## TCP数据包结构

![](http://pwoodong.gitee.io/blog/img/202103/tcp-data-package.png)

##### 源端口号(16位)

​	标识源主机的一个应用进程

##### 目的端口号(16位)

​	标识目的主机的一个应用进程

​	IP报头中的源主机IP地址、目的主机的IP地址和源端口、目的端口确定了唯一一条TCP连接

##### 顺序号seq(32位)

​	标识TCP源端向TCP目的段发送的数据字节流，表示这个报文段中的第1个数据字节的顺序号

##### 确认号ack(32位)

​	村粗发送确认的一端期望收到的下一个顺序号

##### TCP报头长度(4位)

​	存储报头中头部数据的长度，实际指明了数据从哪里开始

##### 保留位(6位)

​	数据保留位，目前必须设置位0

##### 控制位(6位)

​	在TCP报头中有6个标志比特，他们中的多个可被同时设置为1

##### 窗口大小(16位)

​	数据字节数，表示从确认号开始，本报文的源方可以接收的字节数，即源方接收窗口的大小

##### 检验和(16位)

​	对整个TCP报文段，包括TCP头部和TCP数据，以16位字符计算所得

##### 选项

​	最常见的可选字段是最长报文大小，又叫MSS

##### 数据

​	TCP报文段中的数据部分是可选的，在一个连接建立和一个连接终止时，双方交换的报文段仅有TCP首部；如果一方没有数据要发送，则也使用没有任何数据的首部确认收到的数据；在处理超时的许多情况下也会发送部带任何数据的报文段	

## 三次握手

TCP是因特网的传输层协议，使用三次握手建立连接；在客户端主动发出SYN连接请求后，等待对方回答SYN+ACK，并最终对对方的SYN执行ACK确认；这种建立连接的方式可以防止产生错误的连接，TCP使用流量的控制协议是可变大小的滑动窗口协议

### 流程

​	![](http://pwoodong.gitee.io/blog/img/202103/tcp-three-handshakes.png)

​	1、客户端发送SYN(seq=x)报文给服务器端，进入SYN_SEND状态

​	2、服务器端收到SYN报文，回应一个SYN(seq=y)和ACK(ack=x+1)报文，进入SYN_RECV状态

​	3、客户端收到服务器端的SYN报文，回应一个ACK(ack=y+1)报文，进入Established状态；在三次握手完成后，TCP客户端和服务器端成功建立连接，可以开始传播数据了



## 四次挥手

TCP在建立连接时要进行三次握手，在断开连接时要进行四次挥手，这是由于TCP的半关闭造成的；因为TCP连接是全双工的，所以在进行关闭时对每个方向都要单独进行关闭，这种单方向的关闭叫作半关闭；在一方完成它的数据发送任务时，就发送一个FIN来向另一方通告将要终止这个方向的连接

### 流程

​	![](http://pwoodong.gitee.io/blog/img/202103/tcp-four-waves.png)

​	1、客户端应用进程调用断开连接请求，向服务器端发送一个终止标志位FIN=1，seq=u的消息，表示在客户端关闭链路前要发送的数据已经安全发送完毕，可以开始关闭链路操作，并请求服务器端确认关闭客户端到服务器的链路操作；此时客户端处于FIN-WAIT-1状态

​	2、服务器在收到这个FIN消息后返回一个ACK=1，ack=u+1，seq=v的消息给客户端，表示接收到客户端断开链路的操作请求，这时TCP服务器端进程通知高层应用进程释放客户端服务器的链路，服务器处于CLOSE-WAIT状态，即半关闭状态；客户端在收到消息后处于FIN-WAIT-2状态

​	3、服务器端将关闭链路前需要发送给客户端的消息发送给客户端，在等待该数据发送完成后，发送一个终止标志位FIN=1，ACK=1，seq=w，ack=u+1的消息给客户端，表示关闭链路前服务器需要向客户端发送的消息已经发送完毕，请求客户端确认关闭从服务器到客户端的链路操作，此时服务器端处于LAST-ACK状态，等待客户端最终断开链路

​	4、客户端在接收到这个最终FIN消息后，发送一个ACK=1，seq=u+1,ack=w+1的消息给服务器，表示接收到服务器端的断开连接请求并准备断开服务器端到客户端的链路，此时客户端处于TIM-WAIT状态，TCP连接还没有释放，然后经过等待计时器设置的时间后，客户端将进入CLOSE状态